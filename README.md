# Система онлайн-магазина: Асинхронное межсервисное взаимодействие

## Описание проекта
Микросервисная система для управления заказами и оплатами в онлайн-магазине. Решение разработано для обеспечения масштабируемости и надёжности ключевых бизнес-процессов в условиях высокой нагрузки (например, сезонных распродаж).

## Архитектура системы
Система состоит из трёх основных компонентов:

1. **API Gateway (порт 8000)**
   - Отвечает за маршрутизацию и агрегацию запросов между клиентами и микросервисами
   - Реализован с использованием YARP (Yet Another Reverse Proxy)
   - Предоставляет единый Swagger-интерфейс для всех операций

2. **Orders Service (порт 8082)**
   - Управляет созданием заказов, просмотром списка и статуса заказов
   - Асинхронно инициирует процесс оплаты через Kafka
   - Использует паттерн Transactional Outbox для гарантированной доставки событий

3. **Payments Service (порт 8080)**
   - Управляет счетами пользователей: создание, пополнение, просмотр баланса
   - Обрабатывает события оплаты заказов из Kafka
   - Использует паттерны Transactional Inbox и Outbox для надёжной обработки событий и генерации новых
   - Гарантирует семантику at most once (и частично exactly once) при списании средств

### Взаимодействие сервисов
- Для асинхронного взаимодействия используется Kafka
- Orders Service публикует события о необходимости оплаты заказа
- Payments Service обрабатывает события, обновляет баланс и отправляет статус оплаты обратно
- Orders Service обновляет статус заказа на основе событий оплаты

## Основной функционал
### Payments Service
1. Создание счёта пользователя (один счёт на пользователя)
2. Пополнение счёта
3. Просмотр баланса

### Orders Service
1. Создание заказа (асинхронно инициирует оплату)
2. Просмотр списка заказов
3. Просмотр статуса заказа

## API Endpoints

### API Gateway (порт 8000)
- Проксирует все запросы к OrdersService и PaymentsService
- Swagger UI доступен по адресу: http://localhost:8000/swagger

#### OrdersProxy
- `POST /api/OrdersProxy` — Создать заказ
- `GET /api/OrdersProxy` — Получить список заказов
- `GET /api/OrdersProxy/{id}` — Получить статус заказа

#### PaymentsProxy
- `POST /api/PaymentsProxy/{userId}` — Создать счёт пользователя
- `POST /api/PaymentsProxy/{userId}/deposit` — Пополнить счёт
- `GET /api/PaymentsProxy/{userId}/balance` — Просмотреть баланс

## Технологии
- .NET 8.0
- ASP.NET Core
- Entity Framework Core
- PostgreSQL (для хранения данных сервисов)
- Kafka (для асинхронного взаимодействия)
- YARP Reverse Proxy
- Docker, Docker Compose
- Swagger/OpenAPI

## Паттерны
- **Transactional Outbox** (Orders Service): гарантирует, что событие оплаты будет отправлено только после успешной фиксации заказа в БД
- **Transactional Inbox/Outbox** (Payments Service): гарантирует, что событие оплаты будет обработано ровно один раз, а статус оплаты будет отправлен обратно только после успешного обновления баланса
- **Exactly once** (частично): при списании средств используется транзакция и идемпотентная обработка событий

## Запуск проекта
1. Запустите всю систему одной командой:
   ```bash
   docker compose up -d --build
   ```
2. Swagger UI для тестирования доступен по адресу: http://localhost:8000/swagger

## Обработка ошибок и устойчивость
- Все сервисы логируют ошибки и некорректные события
- Реализована повторная обработка неудачных событий (retry)
- При недоступности Kafka сервисы продолжают работу и восстанавливают обработку после восстановления очереди

## Примеры сценариев
- Создание счёта, пополнение, просмотр баланса через PaymentsProxy
- Создание заказа, асинхронная оплата, просмотр статуса через OrdersProxy
- Все сценарии покрыты Swagger UI

## Контейнеризация
- Каждый сервис упакован в отдельный Docker-контейнер
- Вся система разворачивается через `docker-compose.yml`
- После запуска `docker compose up` все сервисы и Kafka становятся доступны автоматически 